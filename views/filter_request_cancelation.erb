<%
user = @login.user
sid = params[:sid]
url = params[:return_url] || '/settings/subscriptions'
s = BlackStack::I2P::Subscription.where(:id=>sid).first

redirect "#{url}?err=Subscription%20Not%20Found." if s.nil?
redirect "#{url}?err=Cancelation%20Denied." if s.id_account.to_guid != user.id_account.to_guid

# Create ticket
text = <<~EMAIL
  <h1>Subscription Cancelation Request</h1>
  <b>User Email:</b> #{@login.user.email}<br/>
  <b>Subscription:</b> #{s.subscr_id}<br/>
  <br/>
  ---
  This is an automated message generated by the onboarding system.
EMAIL
h = {}
h[:receiver_name] = 'Requirement'
h[:receiver_email] = HELPDESK_EMAIL
h[:subject] = "Subscription Cancelation Request"
h[:body] = text
BlackStack::Emails.delivery(h)

# Track cancelation request - For doing this automatically in the future.
s.cancellation_requested = true
s.cancellation_request_time = now
s.cancellation_request_id_user = real_user.id
s.save

# redireccionar al dashboard
redirect "#{url}?msg=Cancelation%20Requested."
%>